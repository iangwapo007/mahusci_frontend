<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Assessment Results</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script type="module" src="js/utils/utils.js"></script>
    <style>
      :root {
        --primary-color: #447ee2;
        --secondary-color: #447ee2;
        --accent-color: #4cc9f0;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --gray-color: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
      }

      body {
        background-color: #f5f7fa;
        font-family: "Poppins", sans-serif;
        color: #333;
        padding-left: 280px; /* Added for sidebar */
      }

      /* Sidebar Styles */
      .sidebar {
        border-top-right-radius: 15px;
        border-bottom-right-radius: 15px;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 300px;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 20px 0;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 0 10px 10px;
        border-bottom: 1px solid #e9e9e9;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .sidebar-logo {
        width: 160px;
      }

      .sidebar-nav {
        padding: 0 15px;
      }

      .nav-item {
        margin-bottom: 5px;
      }

      .nav-link {
        font-size: 14px;
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 8px;
        color: #333;
        transition: var(--transition);
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(68, 126, 226, 0.1);
        color: var(--primary-color);
      }

      .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .profile-section {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        margin-top: auto;
      }

      .profile-info {
        display: flex;
        align-items: center;
      }

      .profile-picture {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
        border: 2px solid #447ee2;
      }

      .profile-name {
        font-weight: 600;
        font-size: 14px;
        line-height: 1.2;
      }

      .profile-role {
        font-size: 12px;
        color: var(--gray-color);
      }

      /* Main Content Styles */
      .main-content {
        padding: 30px;
      }

      /* Dashboard Specific Styles */
      .welcome-card {
        background: linear-gradient(135deg, #447ee2, #4cc9f0);
        color: white;
        border-radius: var(--border-radius);
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: var(--box-shadow);
      }

      .results-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--box-shadow);
        margin-bottom: 30px;
      }

      .student-card {
        border-radius: var(--border-radius);
        padding: 15px;
        margin-bottom: 15px;
        background-color: var(--light-color);
        transition: var(--transition);
      }

      .student-card:hover {
        background-color: rgba(68, 126, 226, 0.05);
      }

      .score-input {
        max-width: 100px;
        text-align: center;
      }

      .answers-table {
        width: 100%;
        border-collapse: collapse;
      }

      .answers-table th,
      .answers-table td {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .answers-table th {
        text-align: left;
        font-weight: 500;
        color: var(--gray-color);
      }

      .correct-answer {
        background-color: rgba(76, 175, 80, 0.1);
        border-left: 3px solid var(--success-color);
      }

      .incorrect-answer {
        background-color: rgba(244, 67, 54, 0.1);
        border-left: 3px solid var(--danger-color);
      }

      /* Responsive adjustments */
      @media (max-width: 992px) {
        body {
          padding-left: 0;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          width: 100%;
          padding: 20px;
        }

        .sidebar-toggle {
          display: block !important;
        }
      }

      /* Rest of your existing CSS remains unchanged */
      .btn-primary {
        background-color: var(--primary-color);
      }

      .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
        transition: var(--transition);
      }

      .sidebar-toggle {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        display: none;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
      }

      /* Chrome, Edge, Safari */
      ::-webkit-scrollbar {
        width: 20px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: #f0f0f0; /* light gray background */
      }

      ::-webkit-scrollbar-thumb {
        background-color: #d1d1d1; /* primary scrollbar color */
        border-radius: 6px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-thumb:hover {
        background-color: #d1d1d1; /* darker on hover */
      }

      /* Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: #d1d1d1 #f0f0f0;
      }
    </style>
  </head>
  <body>
    <div
      class="fullscreen-spinner d-none d-flex justify-content-center align-items-center bg-white"
    >
      <div class="spinner"></div>
    </div>

    <style>
      .fullscreen-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
      }

      .spinner {
        width: 90px;
        height: 90px;
        display: grid;
      }

      .spinner::before,
      .spinner::after {
        content: "";
        grid-area: 1/1;
        background: radial-gradient(farthest-side, #cb6ce6 92%, #0000) 50% 0,
          /* Top - M */ radial-gradient(farthest-side, #7ed957 92%, #0000) 50%
            100%,
          /* Bottom - a */ radial-gradient(farthest-side, #ffde59 92%, #0000)
            100% 50%,
          /* Right - h */ radial-gradient(farthest-side, #ff914d 92%, #0000) 0
            50%; /* Left - u */
        background-size: 20.4px 20.4px;
        background-repeat: no-repeat;
        animation: spinner-3hs4a3 1s infinite;
      }

      .spinner::before {
        margin: 4.5px;
        background-size: 13px 13px;
        animation-timing-function: linear;
      }

      @keyframes spinner-3hs4a3 {
        100% {
          transform: rotate(0.5turn);
        }
      }
    </style>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img
          src="/src/images/mahusci-banner-logo.png"
          class="sidebar-logo"
          alt="Logo"
        />
      </div>

      <nav class="sidebar-nav">
        <ul class="nav flex-column">
          <!-- GENERAL -->
          <li
            class="nav-label text-uppercase text-muted px-3 small"
            style="font-size: 13px; color: #447ee2 !important"
          >
            General
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/dashboard.html">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>

          <!-- MANAGEMENT -->
          <li
            class="nav-label text-uppercase text-muted px-3 mt-3 small"
            style="font-size: 13px; color: #447ee2 !important"
          >
            Management
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/lessons.html">
              <i class="fas fa-book"></i>
              <span> Lessons</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/assessments.html">
              <i class="fas fa-clipboard-list"></i>
              <span>Assessments</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/manage-sequence.html">
              <i class="fas fa-project-diagram"></i>
              <span> Sequences</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/curriculum-sequence.html">
              <i class="fas fa-sitemap"></i>
              <span class="text-nowrap"> Curriculum Sequence</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/teacher/student-results.html">
              <i class="fas fa-user-graduate"></i>
              <span> Student Results</span>
            </a>
          </li>

          <!-- CREATION -->
          <li
            class="nav-label text-uppercase text-muted px-3 mt-3 small pb-1"
            style="font-size: 13px; color: #447ee2 !important"
          >
            Creation
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/sequence-builder.html">
              <i class="fas fa-cogs"></i>
              <span>Sequence Builder</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/create-lesson.html">
              <i class="fas fa-plus-circle"></i>
              <span>Create Lesson</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/create-assessment.html">
              <i class="fas fa-plus-square"></i>
              <span>Create Assessment</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- PROFILE -->
      <div class="profile-section mt-4">
        <a href="myProfile.html" class="text-decoration-none text-reset">
          <div class="profile-info d-flex align-items-center px-3 py-2">
            <img
              src="/src/images/teacher-profile.png"
              class="profile-picture me-2"
              alt="Profile"
            />
            <div>
              <div class="profile-name fw-semibold">Ms. Rodriguez</div>
              <div class="profile-role text-muted small">Science Teacher</div>
            </div>
          </div>
        </a>
      </div>
      <div class="d-flex justify-content-center">
        <button class="w-75 btn-primary btn mt-1" id="btn_logout">
          logout
        </button>
      </div>
    </div>

    <!-- Mobile Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <!-- Welcome Card -->
        <div class="welcome-card">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h2>Student Assessment Results</h2>
              <p class="mb-0">
                View and manage student assessment scores and answers
              </p>
            </div>
            <div class="col-md-4 text-md-end">
              <div
                class="d-inline-block bg-white text-primary px-3 py-2 rounded-pill"
              >
                <i class="fas fa-calendar-day me-2"></i>
                <span id="currentDate">Monday, January 1, 2023</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sequence Selection -->
        <div class="results-container mb-4">
          <div class="row">
            <div class="col-md-6">
              <label for="sequenceFilter" class="form-label"
                >Select Sequence</label
              >
              <select class="form-select" id="sequenceFilter">
                <option value="">Loading sequences...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="assessmentFilter" class="form-label"
                >Select Assessment</label
              >
              <select class="form-select" id="assessmentFilter" disabled>
                <option value="">Select a sequence first</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Student Results -->
        <div class="results-container">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Student Results</h4>
            <button id="saveScoresBtn" class="btn btn-primary" disabled>
              <i class="fas fa-save me-2"></i>Save Scores
            </button>
          </div>

          <div id="studentResults">
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
              <p class="mt-3">
                Select a sequence and assessment to view results
              </p>
            </div>
          </div>
        </div>

        <!-- Answers Modal -->
        <div
          class="modal fade"
          id="answersModal"
          tabindex="-1"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="answersModalTitle">
                  Student Answers
                </h5>
                <button
                  type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <div id="modalLoading" class="text-center py-5">
                  <div class="spinner-border text-primary"></div>
                  <p class="mt-3">Loading student answers...</p>
                </div>
                <div id="answersContent" class="d-none">
                  <div class="mb-4">
                    <h5 id="studentName"></h5>
                    <div class="d-flex justify-content-between">
                      <div>
                        <small class="text-muted">Assessment:</small>
                        <span id="assessmentTitle" class="fw-medium"></span>
                      </div>
                      <div>
                        <small class="text-muted">Score:</small>
                        <span id="studentScore" class="fw-medium"></span>
                      </div>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="answers-table">
                      <thead>
                        <tr>
                          <th>Question</th>
                          <th>Student Answer</th>
                          <th>Correct Answer</th>
                          <th>Points</th>
                        </tr>
                      </thead>
                      <tbody id="answersTableBody">
                        <!-- Answers will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const userData = JSON.parse(sessionStorage.getItem("user-data"));
      document.querySelector(".profile-name").textContent =
        userData.firstname + " " + userData.lastname || "-";
      document.querySelector(".profile-role").textContent =
        userData.role || "-";

      // Profile picture
      const profilePictureElement = document.querySelector(".profile-picture");

      if (userData.profile_picture) {
        profilePictureElement.src = `https://mahusci.rubenianinternational.com/storage/app/public/${userData.profile_picture}`;
      } else {
        profilePictureElement.src = `/src/images/profile.jpg`;
      }

      // Toggle sidebar on mobile
      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          document.querySelector(".sidebar").classList.toggle("active");
        });

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", function (event) {
        const sidebar = document.querySelector(".sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");

        if (
          window.innerWidth <= 992 &&
          !sidebar.contains(event.target) &&
          event.target !== toggleBtn &&
          !toggleBtn.contains(event.target)
        ) {
          sidebar.classList.remove("active");
        }
      });

      // Set current date
      function updateCurrentDate() {
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        document.getElementById("currentDate").textContent =
          new Date().toLocaleDateString("en-US", options);
      }

      // Global variables
      let currentSequenceId = null;
      let currentAssessmentId = null;
      let studentResults = [];
      const answersModal = new bootstrap.Modal("#answersModal");
      let modifiedScores = {};

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        updateCurrentDate();
        loadTeacherSequences();
        setupEventListeners();
      });

      function setupEventListeners() {
        // Sequence filter change
        document
          .getElementById("sequenceFilter")
          .addEventListener("change", function () {
            currentSequenceId = this.value;
            console.log(currentSequenceId);
            document.getElementById("assessmentFilter").disabled =
              !currentSequenceId;
            if (currentSequenceId) {
              loadAssessmentsForSequence(currentSequenceId);
            } else {
              document.getElementById("assessmentFilter").innerHTML =
                '<option value="">Select a sequence first</option>';
              document.getElementById("studentResults").innerHTML = `
              <div class="text-center py-5">
                <p class="mt-3">Select a sequence and assessment to view results</p>
              </div>
            `;
            }
          });

        // Assessment filter change
        document
          .getElementById("assessmentFilter")
          .addEventListener("change", function () {
            currentAssessmentId = this.value;
            document.getElementById("saveScoresBtn").disabled =
              !currentAssessmentId;
            if (currentAssessmentId && currentSequenceId) {
              loadStudentResults(currentSequenceId, currentAssessmentId);
            } else {
              document.getElementById("studentResults").innerHTML = `
              <div class="text-center py-5">
                <p class="mt-3">Select a sequence and assessment to view results</p>
              </div>
            `;
            }
          });

        // Save scores button
        document
          .getElementById("saveScoresBtn")
          .addEventListener("click", saveStudentScores);
      }

      // Load teacher's sequences
      async function loadTeacherSequences() {
        try {
          const response = await fetch(
            "https://mahusci.rubenianinternational.com/public/api/sequences",
            {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("token"),
                Accept: "application/json",
              },
            }
          );

          const data = await response.json();

          const sequenceFilter = document.getElementById("sequenceFilter");
          if (data && data.length > 0) {
            console.log(data);

            sequenceFilter.innerHTML =
              '<option value="">Select a sequence</option>' +
              data
                .map(
                  (seq) =>
                    `<option value="${seq.id}">${seq.title} (Quarter ${seq.quarter})</option>`
                )
                .join("");
          } else {
            sequenceFilter.innerHTML =
              '<option value="">No sequences found</option>';
          }
        } catch (error) {
          console.error("Error loading sequences:", error);
          document.getElementById("sequenceFilter").innerHTML =
            '<option value="">Error loading sequences</option>';
        }
      }

      // Load assessments for selected sequence
      async function loadAssessmentsForSequence(sequenceId) {
        try {
          const response = await fetch(
            `https://mahusci.rubenianinternational.com/public/api/sequences/${sequenceId}/assessments`,
            {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("token"),
                Accept: "application/json",
              },
            }
          );

          const data = await response.json();
          const assessmentFilter = document.getElementById("assessmentFilter");

          if (data.data && data.data.length > 0) {
            assessmentFilter.innerHTML =
              '<option value="">Select an assessment</option>' +
              data.data
                .map(
                  (assess) =>
                    `<option value="${assess.id}">${assess.title} (${formatType(
                      assess.type
                    )})</option>`
                )
                .join("");
            assessmentFilter.disabled = false;
          } else {
            assessmentFilter.innerHTML =
              '<option value="">No assessments in this sequence</option>';
            assessmentFilter.disabled = false;
          }
        } catch (error) {
          console.error("Error loading assessments:", error);
          document.getElementById("assessmentFilter").innerHTML =
            '<option value="">Error loading assessments</option>';
        }
      }

      // Load student results for selected sequence and assessment
      async function loadStudentResults(sequenceId, assessmentId) {
        try {
          document.getElementById("studentResults").innerHTML = `
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
              <p class="mt-3">Loading student results...</p>
            </div>
          `;

          const response = await fetch(
            `https://mahusci.rubenianinternational.com/public/api/sequences/${sequenceId}/assessments/${assessmentId}/results`,
            {
              headers: {
                Authorization: "Bearer " + sessionStorage.getItem("token"),
                Accept: "application/json",
              },
            }
          );

          const data = await response.json();
          studentResults = data.data || [];

          if (studentResults.length > 0) {
            displayStudentResults(studentResults);
            document.getElementById("saveScoresBtn").disabled = false;
          } else {
            document.getElementById("studentResults").innerHTML = `
              <div class="text-center py-5">
                <i class="fas fa-user-graduate fa-3x mb-3 text-muted"></i>
                <p>No students have taken this assessment yet</p>
              </div>
            `;
            document.getElementById("saveScoresBtn").disabled = true;
          }
        } catch (error) {
          console.error("Error loading student results:", error);
          document.getElementById("studentResults").innerHTML = `
            <div class="alert alert-danger">
              Failed to load student results. Please try again.
            </div>
          `;
        }
      }

      // Display student results
      function displayStudentResults(results) {
        const container = document.getElementById("studentResults");
        modifiedScores = {}; // Reset modified scores

        let html = "";
        results.forEach((result) => {
          html += `
            <div class="student-card">
              <div class="row align-items-center">
                <div class="col-md-4">
                  <h6 class="mb-1">${result.student.name}</h6>
                  <small class="text-muted">${result.student.email}</small>
                </div>
                <div class="col-md-3">
                  <div class="input-group">
                    <input type="number"
                           class="form-control score-input"
                           value="${result.score}"
                           min="0"
                           max="${result.total_points}"
                           data-result-id="${result.id}">
                    <span class="input-group-text">/ ${result.total_points}</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="progress">
                    <div class="progress-bar"
                         role="progressbar"
                         style="width: ${result.percentage}%"
                         aria-valuenow="${result.percentage}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      ${result.percentage}%
                    </div>
                  </div>
                </div>
                <div class="col-md-2 text-end">
                  <button class="btn btn-sm btn-outline-primary view-answers-btn"
                          data-result-id="${result.id}">
                    <i class="fas fa-eye me-1"></i> View
                  </button>
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;

        // Add event listeners to score inputs
        document.querySelectorAll(".score-input").forEach((input) => {
          input.addEventListener("change", function () {
            const resultId = this.dataset.resultId;
            modifiedScores[resultId] = this.value;
          });
        });

        // Add event listeners to view buttons
        document.querySelectorAll(".view-answers-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const resultId = this.dataset.resultId;
            viewStudentAnswers(resultId);
          });
        });
      }

      //  viewStudentAnswers function with proper scoring logic
      async function viewStudentAnswers(resultId) {
        const result = studentResults.find((r) => r.id == resultId);
        if (!result) return;

        // Show loading state
        document.getElementById("modalLoading").classList.remove("d-none");
        document.getElementById("answersContent").classList.add("d-none");
        answersModal.show();

        try {
          // Set basic info
          document.getElementById("studentName").textContent =
            result.student.name || result.student.email;
          document.getElementById("assessmentTitle").textContent =
            result.assessment.title;
          document.getElementById(
            "studentScore"
          ).textContent = `${result.score} / ${result.total_points}`;

          // Load assessment questions if not already loaded
          if (!result.assessment.questions) {
            const assessmentRes = await fetch(
              `https://mahusci.rubenianinternational.com/public/api/lessons/assessments/${result.assessment.id}`,
              {
                headers: {
                  Authorization: "Bearer " + sessionStorage.getItem("token"),
                  Accept: "application/json",
                },
              }
            );
            const assessmentData = await assessmentRes.json();
            result.assessment.questions = assessmentData.data.questions;

            // Parse questions if they're stored as JSON string
            if (typeof result.assessment.questions === "string") {
              result.assessment.questions = JSON.parse(
                result.assessment.questions
              );
            }
          }

          // Calculate points per question
          const pointsPerQuestion =
            result.total_points / result.assessment.questions.length;

          // Display answers based on assessment type
          const tableBody = document.getElementById("answersTableBody");
          tableBody.innerHTML = "";

          if (result.assessment.type === "mind_mapping") {
            displayMindMappingAnswers(result, tableBody, pointsPerQuestion);
          } else if (result.assessment.type === "comparison_table") {
            displayComparisonTableAnswers(result, tableBody, pointsPerQuestion);
          } else if (result.assessment.type === "4pics1word") {
            displayFourPicsAnswers(result, tableBody, pointsPerQuestion);
          } else if (result.assessment.type === "matching") {
            displayMatchingAnswers(result, tableBody, pointsPerQuestion);
          } else {
            displayDefaultAnswers(result, tableBody, pointsPerQuestion);
          }

          // Show content
          document.getElementById("modalLoading").classList.add("d-none");
          document.getElementById("answersContent").classList.remove("d-none");
        } catch (error) {
          console.error("Error loading student answers:", error);
          document.getElementById("modalLoading").innerHTML = `
      <div class="alert alert-danger">
        Failed to load student answers. Please try again.
      </div>
    `;
        }
      }

      // Helper functions for different answer types with proper scoring
      function displayDefaultAnswers(result, tableBody, pointsPerQuestion) {
        result.assessment.questions.forEach((question, index) => {
          const studentAnswer = getStudentAnswer(result, index);
          const isCorrect = checkAnswerCorrectness(
            result.assessment.type,
            studentAnswer,
            question.correctAnswer
          );
          const points = isCorrect ? pointsPerQuestion : 0;

          const row = document.createElement("tr");
          row.className = isCorrect ? "correct-answer" : "incorrect-answer";
          row.innerHTML = `
      <td>${index + 1}. ${
            question.text || question.centralTopic || "Question"
          }</td>
      <td>${formatAnswer(studentAnswer)}</td>
      <td>${formatCorrectAnswer(question, result.assessment.type)}</td>
      <td>${points.toFixed(1)}</td>
    `;
          tableBody.appendChild(row);
        });
      }

      function displayMindMappingAnswers(result, tableBody, pointsPerQuestion) {
        try {
          const studentAnswers = parseAnswers(result.answers);
          const questions = result.assessment.questions;

          questions.forEach((question, qIndex) => {
            const studentBranches = studentAnswers[qIndex]?.branches || [];
            const correctBranches = question.branches || [];

            // Calculate score for each branch
            const branchesPerQuestion = correctBranches.length;
            const pointsPerBranch = pointsPerQuestion / branchesPerQuestion;

            correctBranches.forEach((branch, bIndex) => {
              const studentBranch = studentBranches[bIndex] || {};
              const isCorrect = compareBranches(branch, studentBranch);

              const row = document.createElement("tr");
              row.className = isCorrect ? "correct-answer" : "incorrect-answer";
              row.innerHTML = `
          <td>${qIndex + 1}.${bIndex + 1} ${
                question.centralTopic || "Mind Map"
              }</td>
          <td>${formatAnswer(studentBranch.subBranches)}</td>
          <td>${formatAnswer(branch.subBranches)}</td>
          <td>${isCorrect ? pointsPerBranch.toFixed(1) : 0}</td>
        `;
              tableBody.appendChild(row);
            });
          });
        } catch (e) {
          console.error("Error displaying mind map answers:", e);
          showErrorRow(tableBody, "Error displaying mind map answers");
        }
      }

      function displayComparisonTableAnswers(
        result,
        tableBody,
        pointsPerQuestion
      ) {
        try {
          const studentAnswers = parseAnswers(result.answers);
          const questions = result.assessment.questions;

          questions.forEach((question, qIndex) => {
            const studentTable = studentAnswers[qIndex] || {};
            const correctAnswers = question.correctAnswers || {};

            // Calculate score per row (assuming each row is equally weighted)
            const rows = Object.keys(correctAnswers);
            const pointsPerRow = pointsPerQuestion / rows.length;

            rows.forEach((rowKey) => {
              const isCorrect = compareTableRow(
                correctAnswers[rowKey],
                studentTable[rowKey]
              );

              const row = document.createElement("tr");
              row.className = isCorrect ? "correct-answer" : "incorrect-answer";
              row.innerHTML = `
          <td>${qIndex + 1}. ${rowKey}</td>
          <td>${formatAnswer(studentTable[rowKey])}</td>
          <td>${formatAnswer(correctAnswers[rowKey])}</td>
          <td>${isCorrect ? pointsPerRow.toFixed(1) : 0}</td>
        `;
              tableBody.appendChild(row);
            });
          });
        } catch (e) {
          console.error("Error displaying comparison table:", e);
          showErrorRow(tableBody, "Error displaying comparison table");
        }
      }

      function displayFourPicsAnswers(result, tableBody, pointsPerQuestion) {
        const studentAnswers = Array.isArray(result.answers)
          ? result.answers
          : typeof result.answers === "string"
          ? JSON.parse(result.answers)
          : [];

        result.assessment.questions.forEach((question, index) => {
          const studentAnswer = studentAnswers[index] || "No answer";
          const isCorrect = checkAnswerCorrectness(
            "4pics1word",
            studentAnswer,
            question.correctAnswer
          );

          const row = document.createElement("tr");
          row.className = isCorrect ? "correct-answer" : "incorrect-answer";
          row.innerHTML = `
<td>${index + 1}. ${renderQuestionImages(question.images)}</td>
      <td>${studentAnswer}</td>
      <td>${question.correctAnswer || "Correct answer"}</td>
      <td>${isCorrect ? pointsPerQuestion.toFixed(1) : 0}</td>
    `;
          tableBody.appendChild(row);
        });
      }

      function renderQuestionImages(images) {
        const baseUrl =
          "https://mahusci.rubenianinternational.com/storage/app/public/";

        if (!images || !Array.isArray(images)) {
          return "4 Pics 1 Word";
        }

        return images
          .map(
            (img) =>
              `<img src="${
                baseUrl + img
              }" alt="question image" style="width: 50px; height: 50px; object-fit: cover; margin-right: 5px;" />`
          )
          .join("");
      }

      function displayMatchingAnswers(result, tableBody, pointsPerQuestion) {
        try {
          const studentAnswers = parseAnswers(result.answers);
          const questions = result.assessment.questions;

          questions.forEach((question, qIndex) => {
            const studentMatches = studentAnswers[qIndex]?.matches || [];
            const correctMatches = question.matches || [];

            // Calculate score per match
            const matchesPerQuestion = correctMatches.length;
            const pointsPerMatch =
              matchesPerQuestion > 0
                ? pointsPerQuestion / matchesPerQuestion
                : 0;

            correctMatches.forEach((match, mIndex) => {
              const studentMatch = studentMatches[mIndex] || {};
              const isCorrect = compareMatches(match, studentMatch);

              const row = document.createElement("tr");
              row.className = isCorrect ? "correct-answer" : "incorrect-answer";
              row.innerHTML = `
          <td>${qIndex + 1}.${mIndex + 1} Matching Question</td>
          <td>${formatAnswer(studentMatch)}</td>
          <td>${formatAnswer(match)}</td>
          <td>${isCorrect ? pointsPerMatch.toFixed(1) : 0}</td>
        `;
              tableBody.appendChild(row);
            });
          });
        } catch (e) {
          console.error("Error displaying matching answers:", e);
          showErrorRow(tableBody, "Error displaying matching answers");
        }
      }

      // Helper functions for answer processing and comparison
      function getStudentAnswer(result, index) {
        if (!result.answers) return "No answer";
        if (Array.isArray(result.answers))
          return result.answers[index] || "No answer";
        if (typeof result.answers === "string") {
          try {
            const parsed = JSON.parse(result.answers);
            return Array.isArray(parsed) ? parsed[index] : parsed;
          } catch {
            return "No answer";
          }
        }
        return "No answer";
      }

      function parseAnswers(answers) {
        if (!answers) return [];
        if (Array.isArray(answers)) return answers;
        if (typeof answers === "string") {
          try {
            return JSON.parse(answers);
          } catch {
            return [];
          }
        }
        return [];
      }

      function checkAnswerCorrectness(type, studentAnswer, correctAnswer) {
        if (!studentAnswer || !correctAnswer) return false;

        switch (type) {
          case "multiple_choice":
          case "true_false":
          case "short_answer":
          case "4pics1word":
            return (
              String(studentAnswer).toLowerCase().trim() ===
              String(correctAnswer).toLowerCase().trim()
            );

          case "essay":
            // Essay questions typically get full points or are manually graded
            return true;

          default:
            return false;
        }
      }

      function compareBranches(correctBranch, studentBranch) {
        if (!correctBranch || !studentBranch) return false;
        return (
          String(correctBranch.subBranches).toLowerCase().trim() ===
          String(studentBranch.subBranches).toLowerCase().trim()
        );
      }

      function compareTableRow(correctRow, studentRow) {
        if (typeof correctRow === "object" && typeof studentRow === "object") {
          return JSON.stringify(correctRow) === JSON.stringify(studentRow);
        }
        return (
          String(correctRow).toLowerCase().trim() ===
          String(studentRow).toLowerCase().trim()
        );
      }

      function compareMatches(correctMatch, studentMatch) {
        if (
          typeof correctMatch === "object" &&
          typeof studentMatch === "object"
        ) {
          return JSON.stringify(correctMatch) === JSON.stringify(studentMatch);
        }
        return (
          String(correctMatch).toLowerCase().trim() ===
          String(studentMatch).toLowerCase().trim()
        );
      }

      function formatCorrectAnswer(question, type) {
        switch (type) {
          case "multiple_choice":
            console.log(question.options);
            return (
              question.options?.find(
                (opt) => opt.value === question.correctAnswer
              )?.value +
                ". " +
                question.options?.find(
                  (opt) => opt.value === question.correctAnswer
                )?.text || question.correctAnswer
            );

          case "mind_mapping":
            return (
              question.branches?.map((b) => b.subBranches).join(", ") || ""
            );

          case "comparison_table":
            return JSON.stringify(question.correctAnswers);

          case "matching":
            return question.matches?.join(", ") || "";

          default:
            return question.correctAnswer || "See rubric";
        }
      }

      function formatAnswer(answer) {
        if (answer === null || answer === undefined) return "No answer";
        if (Array.isArray(answer)) return answer.join(", ");
        if (typeof answer === "object") return JSON.stringify(answer);
        return answer;
      }

      function showErrorRow(tableBody, message) {
        const row = document.createElement("tr");
        row.innerHTML = `
    <td colspan="4" class="text-danger">
      ${message}
    </td>
  `;
        tableBody.appendChild(row);
      }

      // Save modified scores
      async function saveStudentScores() {
        if (Object.keys(modifiedScores).length === 0) {
          alert("No scores have been modified");
          return;
        }

        try {
          document.getElementById("saveScoresBtn").disabled = true;
          document.getElementById("saveScoresBtn").innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Saving...
          `;

          const response = await fetch(
            `https://mahusci.rubenianinternational.com/public/api/assessment-results/update-scores`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + sessionStorage.getItem("token"),
                Accept: "application/json",
              },
              body: JSON.stringify({
                scores: modifiedScores,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("Scores updated successfully");
            // Refresh the results
            loadStudentResults(currentSequenceId, currentAssessmentId);
          } else {
            throw new Error(data.message || "Failed to update scores");
          }
        } catch (error) {
          console.error("Error saving scores:", error);
          alert("Error saving scores: " + error.message);
        } finally {
          document.getElementById("saveScoresBtn").disabled = false;
          document.getElementById("saveScoresBtn").innerHTML = `
            <i class="fas fa-save me-2"></i>Save Scores
          `;
        }
      }

      // Helper function to format assessment type
      function formatType(type) {
        const types = {
          multiple_choice: "Multiple Choice",
          true_false: "True/False",
          essay: "Essay",
          short_answer: "Short Answer",
          matching: "Matching",
          fill_blank: "Fill in Blank",
          comparison_table: "Comparison Table",
          mind_mapping: "Mind Mapping",
          "4pics1word": "4 Pics 1 Word",
        };
        return types[type] || type;
      }
    </script>
  </body>
</html>
