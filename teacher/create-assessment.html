<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MahuSci | Create Assessment</title>
    <link rel="icon" type="image/png" href="/src/images/logo.png" />
    <link rel="stylesheet" href="/teacher/css/custom.css" />
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Poppins"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css?family=" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=Jost"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Cabin Sketch"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://cdn.ckeditor.com/4.20.2/standard/ckeditor.js"></script>
    <script type="module" src="js/utils/utils.js"></script>
    <style>
      :root {
        --primary-color: #447ee2;
        --secondary-color: #447ee2;
        --accent-color: #447ee2;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --border-radius: 12px;
        --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
      }

      body {
        background-color: #f5f7fa;
        font-family: "Poppins", sans-serif;
        background-image: url(/src/images/quiz\ bg.jpg);
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
        padding-left: 280px; /* Added for sidebar */
      }

      /* Sidebar Styles */
      .sidebar {
        border-top-right-radius: 15px;
        border-bottom-right-radius: 15px;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 300px;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 20px 0;
        overflow-y: auto;
      }

      .sidebar-header {
        padding: 0 10px 10px;
        border-bottom: 1px solid #e9e9e9;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .sidebar-logo {
        width: 160px;
      }

      .sidebar-nav {
        padding: 0 15px;
      }

      .nav-item {
        margin-bottom: 5px;
      }

      .nav-link {
        font-size: 14px;
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 8px;
        color: #333;
        transition: var(--transition);
      }
      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(68, 126, 226, 0.1);
        color: var(--primary-color);
      }

      .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .profile-section {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        margin-top: auto;
      }

      .profile-info {
        display: flex;
        align-items: center;
      }

      .profile-picture {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
        border: 2px solid #447ee2;
      }

      .profile-name {
        font-weight: 600;
        font-size: 14px;
        line-height: 1.2;
      }

      .profile-role {
        font-size: 12px;
        color: var(--gray-color);
      }

      /* Main Content Styles */
      .main-content {
        padding: 30px;
      }

      /* Modern Card Design */
      .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 1.5rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
      }

      /* Enhanced Form Elements */
      .form-control,
      .form-select {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        transition: var(--transition);
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      }

      /* Modern Button Styles */
      .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
        transition: var(--transition);
      }

      .btn-primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background: var(--secondary-color);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
      }

      /* Question Section Styling */
      .question-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
      }

      .question-section:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background-color: var(--primary-color);
      }

      .modal-header {
        background-color: var(--primary-color);
      }

      /* Dynamic Field Interactions */
      .add-option-btn,
      .remove-question-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        transition: var(--transition);
      }

      .add-option-btn:hover {
        background: var(--primary-color);
        color: white;
      }

      .remove-question-btn:hover {
        background: var(--danger-color);
        color: white;
      }

      /* Modern File Upload */
      .file-upload {
        border: 2px dashed #e0e0e0;
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        transition: var(--transition);
      }

      .file-upload:hover {
        border-color: var(--primary-color);
        background: rgba(67, 97, 238, 0.05);
      }

      /* Enhanced Radio/Checkbox */
      .form-check-input {
        width: 1.2em;
        height: 1.2em;
        margin-top: 0.15em;
      }

      .form-check-label {
        margin-left: 0.5rem;
      }

      /* Grading Rubric Styling */
      .rubric-item {
        border-left: 3px solid var(--primary-color);
        padding-left: 1rem;
        margin-bottom: 1rem;
      }

      /* Mind Mapping Visuals */
      .mind-map-preview {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        min-height: 200px;
        position: relative;
      }

      .node {
        position: absolute;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        box-shadow: var(--box-shadow);
        border: 2px solid var(--primary-color);
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        body {
          padding-left: 0;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          width: 100%;
          padding: 20px;
        }

        .sidebar-toggle {
          display: block !important;
        }
      }

      .sidebar-toggle {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        display: none;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .card-header {
          padding: 1rem;
        }

        .form-control,
        .form-select {
          padding: 0.65rem;
        }

        .btn {
          padding: 0.65rem 1rem;
        }
      }

      /* Animation Enhancements */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .new-question {
        animation: fadeIn 0.4s ease;
      }
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .card-header {
        border-radius: 10px 10px 0 0 !important;
      }
      .content-section {
        background-color: white;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }
      .content-section:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .grade-checkboxes .form-check {
        margin-right: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .btn-primary {
        background-color: #447ee2;
        border-color: #447ee2;
      }
      .btn-primary:hover {
        background-color: #2c6e8b;
        border-color: #2c6e8b;
      }
      .btn-outline-primary {
        color: #447ee2;
        border-color: #447ee2;
      }
      .btn-outline-primary:hover {
        background-color: #447ee2;
        color: white;
      }
      .remove-section {
        transition: all 0.2s;
      }
      .remove-section:hover {
        transform: scale(1.1);
      }
    </style>
  </head>
  <body
    class="poppins"
    style="
      background-image: url(/src/images/quiz\ bg.jpg);
      background-size: 100%;
      background-attachment: fixed;
    "
  >
    <div
      class="fullscreen-spinner d-none d-flex justify-content-center align-items-center bg-white"
    >
      <div class="spinner"></div>
    </div>

    <style>
      .fullscreen-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
      }

      .spinner {
        width: 90px;
        height: 90px;
        display: grid;
      }

      .spinner::before,
      .spinner::after {
        content: "";
        grid-area: 1/1;
        background: radial-gradient(farthest-side, #cb6ce6 92%, #0000) 50% 0,
          /* Top - M */ radial-gradient(farthest-side, #7ed957 92%, #0000) 50%
            100%,
          /* Bottom - a */ radial-gradient(farthest-side, #ffde59 92%, #0000)
            100% 50%,
          /* Right - h */ radial-gradient(farthest-side, #ff914d 92%, #0000) 0
            50%; /* Left - u */
        background-size: 20.4px 20.4px;
        background-repeat: no-repeat;
        animation: spinner-3hs4a3 1s infinite;
      }

      .spinner::before {
        margin: 4.5px;
        background-size: 13px 13px;
        animation-timing-function: linear;
      }

      @keyframes spinner-3hs4a3 {
        100% {
          transform: rotate(0.5turn);
        }
      }
    </style>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img
          src="/src/images/mahusci-banner-logo.png"
          class="sidebar-logo"
          alt="Logo"
        />
      </div>

      <nav class="sidebar-nav">
        <ul class="nav flex-column">
          <!-- GENERAL -->
          <li
            class="nav-label text-uppercase text-muted px-3 small"
            style="font-size: 13px; color: #447ee2 !important"
          >
            General
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/dashboard.html">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>

          <!-- MANAGEMENT -->
          <li
            class="nav-label text-uppercase text-muted px-3 mt-3 small"
            style="font-size: 13px; color: #447ee2 !important"
          >
            Management
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/lessons.html">
              <i class="fas fa-book"></i>
              <span> Lessons</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/assessments.html">
              <i class="fas fa-clipboard-list"></i>
              <span>Assessments</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/manage-sequence.html">
              <i class="fas fa-project-diagram"></i>
              <span> Sequences</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/curriculum-sequence.html">
              <i class="fas fa-sitemap"></i>
              <span class="text-nowrap"> Curriculum Sequence</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/student-results.html">
              <i class="fas fa-user-graduate"></i>
              <span> Student Results</span>
            </a>
          </li>

          <!-- CREATION -->
          <li
            class="nav-label text-uppercase text-muted px-3 mt-3 small pb-1"
            style="font-size: 13px; color: #447ee2 !important"
          >
            Creation
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/sequence-builder.html">
              <i class="fas fa-cogs"></i>
              <span>Sequence Builder</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teacher/create-lesson.html">
              <i class="fas fa-plus-circle"></i>
              <span>Create Lesson</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/teacher/create-assessment.html">
              <i class="fas fa-plus-square"></i>
              <span>Create Assessment</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- PROFILE -->
      <div class="profile-section mt-4">
        <a href="myProfile.html" class="text-decoration-none text-reset">
          <div class="profile-info d-flex align-items-center px-3 py-2">
            <img
              src="/src/images/teacher-profile.png"
              class="profile-picture me-2"
              alt="Profile"
            />
            <div>
              <div class="profile-name fw-semibold">Ms. Rodriguez</div>
              <div class="profile-role text-muted small">Science Teacher</div>
            </div>
          </div>
        </a>
      </div>
      <div class="d-flex justify-content-center">
        <button class="w-75 btn-primary btn mt-1" id="btn_logout">
          logout
        </button>
      </div>
    </div>
    <!-- Mobile Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <!-- ASSESSMENT CREATION FORM -->
      <div class="container">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h4 class="mb-0">Create New Assessment</h4>
            </div>
          </div>
          <div class="card-body">
            <form id="assessmentForm">
              <!-- Assessment Basic Information -->
              <div class="mb-4">
                <h5 class="mb-3">Basic Information</h5>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="assessmentTitle" class="form-label"
                      >Assessment Title</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="assessmentTitle"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="assessmentType" class="form-label"
                      >Assessment Type</label
                    >
                    <select class="form-select" id="assessmentType" required>
                      <option value="" selected disabled>
                        Select Assessment Type
                      </option>
                      <option value="multiple_choice">
                        Multiple Choice Quiz
                      </option>
                      <option value="true_false">True/False</option>
                      <option value="short_answer">Short Answer</option>
                      <option value="essay">Essay</option>
                      <option value="matching">Matching</option>
                      <option value="fill_blank">Fill in the Blank</option>
                      <option value="4pics1word">4 Pics 1 Word</option>
                      <option value="comparison_table">Comparison Table</option>
                      <option value="mind_mapping">Mind Mapping</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="totalPoints" class="form-label"
                      >Total Points</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="totalPoints"
                      min="1"
                      required
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="maxPoints" class="form-label"
                      >Passing points</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="maxPoints"
                      min="1"
                      required
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="timeLimit" class="form-label"
                      >Time Limit (minutes)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="timeLimit"
                      min="1"
                      placeholder="Optional"
                    />
                  </div>
                </div>
                <div class="mb-3">
                  <label for="assessmentInstructions " id="" class="form-label"
                    >Instructions</label
                  >
                  <textarea
                    class="form-control editor"
                    id="editor"
                    rows="3"
                  ></textarea>
                </div>
              </div>

              <!-- Dynamic Assessment Fields -->
              <div class="mb-4">
                <h5 class="mb-3">Questions</h5>
                <div id="assessmentFields">
                  <div class="alert alert-info">
                    Please select an assessment type to configure the questions.
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-4">
                <button
                  type="submit"
                  class="btn btn-secondary"
                  id="saveAssessmentDraft"
                >
                  Save as Draft
                </button>
                <button type="submit" class="btn btn-primary">
                  Publish Assessment
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- END OF ASSESSMENT CREATION FORM -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Toggle sidebar on mobile
      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          document.querySelector(".sidebar").classList.toggle("active");
        });

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", function (event) {
        const sidebar = document.querySelector(".sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");

        if (
          window.innerWidth <= 992 &&
          !sidebar.contains(event.target) &&
          event.target !== toggleBtn &&
          !toggleBtn.contains(event.target)
        ) {
          sidebar.classList.remove("active");
        }
      });
    </script>

    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script>
      const userData = JSON.parse(sessionStorage.getItem("user-data"));
      document.querySelector(".profile-name").textContent =
        userData.firstname + " " + userData.lastname || "-";
      document.querySelector(".profile-role").textContent =
        userData.role || "-";

      // Profile picture
      if (userData.profile_picture) {
        document.querySelector(
          ".profile-picture"
        ).src = `https://mahusci.rubenianinternational.com/storage/app/public/${userData.profile_picture}`;
      } else {
        document.querySelector(".profile-picture").src =
          "/src/images/profile.jpg";
      }

      // Initialize CKEditor for the new content section
      CKEDITOR.replace(`editor`, {
        toolbar: [
          {
            name: "basicstyles",
            items: [
              "Bold",
              "Italic",
              "Underline",
              "Strike",
              "Subscript",
              "Superscript",
            ],
          },
          {
            name: "paragraph",
            items: [
              "NumberedList",
              "BulletedList",
              "-",
              "Outdent",
              "Indent",
              "-",
              "Blockquote",
            ],
          },
          { name: "links", items: ["Link", "Unlink"] },
          {
            name: "insert",
            items: ["Table", "HorizontalRule", "SpecialChar"],
          },
          { name: "styles", items: ["Styles", "Format", "Font", "FontSize"] },
          { name: "colors", items: ["TextColor", "BGColor"] },
          { name: "tools", items: ["Maximize", "ShowBlocks"] },
        ],
        height: 200,
        removeButtons: "About",
      });

      // Function to add MCQ question
      function addMcqQuestion() {
        const container = document.getElementById("mcqContainer");
        const questionCount = container.querySelectorAll(".card").length + 1;
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control question-input" placeholder="Question text">
            </div>
            <div class="mb-2">
              <div class="input-group mb-2">
                <div class="input-group-text">
                  <input class="form-check-input correct-answer" type="radio" name="correctAnswer${questionCount}" value="A">
                </div>
                <input type="text" class="form-control option-input" placeholder="Option A">
              </div>
              <div class="input-group mb-2">
                <div class="input-group-text">
                  <input class="form-check-input correct-answer" type="radio" name="correctAnswer${questionCount}" value="B">
                </div>
                <input type="text" class="form-control option-input" placeholder="Option B">
              </div>
              <div class="input-group mb-2">
                <div class="input-group-text">
                  <input class="form-check-input correct-answer" type="radio" name="correctAnswer${questionCount}" value="C">
                </div>
                <input type="text" class="form-control option-input" placeholder="Option C">
              </div>
              <div class="input-group mb-2">
                <div class="input-group-text">
                  <input class="form-check-input correct-answer" type="radio" name="correctAnswer${questionCount}" value="D">
                </div>
                <input type="text" class="form-control option-input" placeholder="Option D">
              </div>
            </div>
            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                <i class="fas fa-trash"></i> Remove
              </button>
              <button class="btn btn-sm btn-outline-success add-option" type="button">
                <i class="fas fa-plus"></i> Add Option
              </button>
            </div>
          </div>
        `;
        container.appendChild(newQuestion);

        // Add event listeners for the new question
        setupMcqQuestionEvents(newQuestion, questionCount);
      }

      // Setup events for MCQ questions
      function setupMcqQuestionEvents(questionElement, questionCount) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });

        questionElement
          .querySelector(".add-option")
          .addEventListener("click", function () {
            const optionsContainer = questionElement.querySelector(".mb-2");
            const optionCount =
              optionsContainer.querySelectorAll(".input-group").length;
            const nextOptionChar = String.fromCharCode(65 + optionCount);

            const newOption = document.createElement("div");
            newOption.className = "input-group mb-2";
            newOption.innerHTML = `
            <div class="input-group-text">
              <input class="form-check-input correct-answer" type="radio" name="correctAnswer${questionCount}" value="${nextOptionChar}">
            </div>
            <input type="text" class="form-control option-input" placeholder="Option ${nextOptionChar}">
            <button class="btn btn-outline-danger remove-option" type="button">
              <i class="fas fa-times"></i>
            </button>
          `;
            optionsContainer.appendChild(newOption);

            newOption
              .querySelector(".remove-option")
              .addEventListener("click", function () {
                newOption.remove();
              });
          });
      }

      // Function to add True/False question
      function addTfQuestion() {
        const container = document.getElementById("tfContainer");
        const questionCount = container.querySelectorAll(".card").length + 1;
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control question-input" placeholder="Question text">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="tfAnswer${questionCount}" id="tfTrue${questionCount}" value="true">
              <label class="form-check-label" for="tfTrue${questionCount}">True</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="tfAnswer${questionCount}" id="tfFalse${questionCount}" value="false">
              <label class="form-check-label" for="tfFalse${questionCount}">False</label>
            </div>
            <button class="btn btn-sm btn-outline-danger mt-2 remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupTfQuestionEvents(newQuestion);
      }

      function setupTfQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Function to add Short Answer question
      function addSaQuestion() {
        const container = document.getElementById("saContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control question-input" placeholder="Question text">
            </div>
            <div class="mb-3">
              <input type="text" class="form-control answer-input" placeholder="Correct answer">
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupSaQuestionEvents(newQuestion);
      }

      function setupSaQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Function to add Essay question
      function addEssayQuestion() {
        const container = document.getElementById("essayContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control question-input" placeholder="Question prompt">
            </div>
            <div class="mb-3">
              <textarea class="form-control" rows="3" placeholder="Sample answer (optional)"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Grading Rubric</label>
              <textarea class="form-control" rows="3" placeholder="Enter grading criteria"></textarea>
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupEssayQuestionEvents(newQuestion);
      }

      function setupEssayQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Function to add Matching question
      function addMatchingQuestion() {
        const container = document.getElementById("matchingContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control question-input" placeholder="Instructions (optional)">
            </div>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Items</label>
                <div class="items-container">
                  <div class="input-group mb-2">
                    <input type="text" class="form-control item-input" placeholder="Item 1">
                    <button class="btn btn-outline-danger remove-item" type="button">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary add-item">
                  <i class="fas fa-plus"></i> Add Item
                </button>
              </div>
              <div class="col-md-6">
                <label class="form-label">Matches</label>
                <div class="matches-container">
                  <div class="input-group mb-2">
                    <input type="text" class="form-control match-input" placeholder="Match 1">
                    <button class="btn btn-outline-danger remove-match" type="button">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary add-match">
                  <i class="fas fa-plus"></i> Add Match
                </button>
              </div>
            </div>
            <button class="btn btn-sm btn-outline-danger mt-3 remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupMatchingQuestionEvents(newQuestion);
      }

      function setupMatchingQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });

        questionElement
          .querySelector(".add-item")
          .addEventListener("click", function () {
            const itemsContainer =
              questionElement.querySelector(".items-container");
            const itemCount =
              itemsContainer.querySelectorAll(".input-group").length + 1;
            const newItem = document.createElement("div");
            newItem.className = "input-group mb-2";
            newItem.innerHTML = `
            <input type="text" class="form-control item-input" placeholder="Item ${itemCount}">
            <button class="btn btn-outline-danger remove-item" type="button">
              <i class="fas fa-times"></i>
            </button>
          `;
            itemsContainer.appendChild(newItem);

            newItem
              .querySelector(".remove-item")
              .addEventListener("click", function () {
                newItem.remove();
              });
          });

        questionElement
          .querySelector(".add-match")
          .addEventListener("click", function () {
            const matchesContainer =
              questionElement.querySelector(".matches-container");
            const matchCount =
              matchesContainer.querySelectorAll(".input-group").length + 1;
            const newMatch = document.createElement("div");
            newMatch.className = "input-group mb-2";
            newMatch.innerHTML = `
            <input type="text" class="form-control match-input" placeholder="Match ${matchCount}">
            <button class="btn btn-outline-danger remove-match" type="button">
              <i class="fas fa-times"></i>
            </button>
          `;
            matchesContainer.appendChild(newMatch);

            newMatch
              .querySelector(".remove-match")
              .addEventListener("click", function () {
                newMatch.remove();
              });
          });
      }

      // Function to add Fill in the Blank question
      function addFillBlankQuestion() {
        const container = document.getElementById("fillBlankContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Question Text (use [blank] for blanks)</label>
              <input type="text" class="form-control question-input" placeholder="E.g., The capital of France is [blank].">
            </div>
            <div class="mb-3">
              <label class="form-label">Correct Answers (separate multiple answers with commas)</label>
              <input type="text" class="form-control answer-input" placeholder="E.g., Paris, paris, PARIS">
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupFillBlankQuestionEvents(newQuestion);
      }

      function setupFillBlankQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Function to add 4 Pics 1 Word question
      function addPicsQuestion() {
        const container = document.getElementById("picsContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Upload 4 Images</label>
              <input type="file" class="form-control mb-2" accept="image/*" multiple>
              <small class="text-muted">Please select exactly 4 images</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Correct Answer</label>
              <input type="text" class="form-control answer-input" placeholder="The word that connects all 4 images">
            </div>
            <div class="mb-3">
              <label class="form-label">Hints (optional)</label>
              <input type="text" class="form-control hint-input" placeholder="E.g., Starts with 'S', 5 letters">
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupPicsQuestionEvents(newQuestion);
      }

      function setupPicsQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Function to add Mind Mapping question
      function addMindMappingQuestion() {
        const container = document.getElementById("mindMappingContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Central Topic</label>
              <input type="text" class="form-control central-topic" placeholder="Enter the central topic">
            </div>
            <div class="mb-3">
              <label class="form-label">Main Branches</label>
              <div class="branches-container">
                <div class="branch-group mb-3 border p-3 rounded">
                  <div class="input-group mb-2">
                    <input type="text" class="form-control branch-input" placeholder="Main branch 1">
                    <button class="btn btn-outline-danger remove-branch" type="button">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div class="sub-branches-container ms-4">
                    <div class="input-group mb-2">
                      <input type="text" class="form-control sub-branch-input" placeholder="Sub-branch 1">
                      <button class="btn btn-outline-danger remove-sub-branch" type="button">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-success add-sub-branch">
                    <i class="fas fa-plus"></i> Add Sub-branch
                  </button>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary add-branch">
                <i class="fas fa-plus"></i> Add Main Branch
              </button>
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupMindMappingQuestionEvents(newQuestion);
      }

      function setupMindMappingQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });

        // Add main branch
        questionElement
          .querySelector(".add-branch")
          .addEventListener("click", function () {
            const branchesContainer = questionElement.querySelector(
              ".branches-container"
            );
            const branchCount =
              branchesContainer.querySelectorAll(".branch-group").length + 1;
            const newBranch = document.createElement("div");
            newBranch.className = "branch-group mb-3 border p-3 rounded";
            newBranch.innerHTML = `
            <div class="input-group mb-2">
              <input type="text" class="form-control branch-input" placeholder="Main branch ${branchCount}">
              <button class="btn btn-outline-danger remove-branch" type="button">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="sub-branches-container ms-4">
              <div class="input-group mb-2">
                <input type="text" class="form-control sub-branch-input" placeholder="Sub-branch 1">
                <button class="btn btn-outline-danger remove-sub-branch" type="button">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-success add-sub-branch">
              <i class="fas fa-plus"></i> Add Sub-branch
            </button>
          `;
            branchesContainer.appendChild(newBranch);

            // Setup events for the new branch
            setupMindMappingBranchEvents(newBranch);
          });

        // Setup events for existing branches
        questionElement.querySelectorAll(".branch-group").forEach((branch) => {
          setupMindMappingBranchEvents(branch);
        });
      }

      function setupMindMappingBranchEvents(branchElement) {
        branchElement
          .querySelector(".remove-branch")
          ?.addEventListener("click", function () {
            branchElement.remove();
          });

        branchElement
          .querySelector(".add-sub-branch")
          ?.addEventListener("click", function () {
            const subBranchesContainer = branchElement.querySelector(
              ".sub-branches-container"
            );
            const subBranchCount =
              subBranchesContainer.querySelectorAll(".input-group").length + 1;
            const newSubBranch = document.createElement("div");
            newSubBranch.className = "input-group mb-2";
            newSubBranch.innerHTML = `
            <input type="text" class="form-control sub-branch-input" placeholder="Sub-branch ${subBranchCount}">
            <button class="btn btn-outline-danger remove-sub-branch" type="button">
              <i class="fas fa-times"></i>
            </button>
          `;
            subBranchesContainer.appendChild(newSubBranch);

            newSubBranch
              .querySelector(".remove-sub-branch")
              .addEventListener("click", function () {
                newSubBranch.remove();
              });
          });
      }

      // Function to add Comparison Table question
      function addComparisonTableQuestion() {
        const container = document.getElementById("comparisonTableContainer");
        const newQuestion = document.createElement("div");
        newQuestion.className = "card mb-3";
        newQuestion.innerHTML = `
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Instructions</label>
              <input type="text" class="form-control question-input" placeholder="Instructions (e.g., Fill in the comparison table)">
            </div>
            <div class="mb-3">
              <label class="form-label">Table Headers (comma separated)</label>
              <input type="text" class="form-control headers-input" placeholder="E.g., Feature,Animal,Plant">
            </div>
            <div class="mb-3">
              <label class="form-label">Row Labels (comma separated)</label>
              <input type="text" class="form-control rows-input" placeholder="E.g., Cell Structure,Reproduction,Energy Source">
            </div>
            <div class="mb-3">
              <label class="form-label">Correct Answers (JSON format)</label>
              <textarea class="form-control answers-input" rows="4" placeholder='[
        {
          "Feature": "Cell Structure",
          "Animal": "No cell wall",
          "Plant": "Has cell wall"
        },
        {
          "Feature": "Reproduction",
          "Animal": "Sexual",
          "Plant": "Asexual or sexual"
        }
      ]'></textarea>
              <small class="form-text text-muted">
                Provide correct answers in array of objects format. Each object should include values for all columns.
              </small>
            </div>
            <button class="btn btn-sm btn-outline-danger remove-question" type="button">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        container.appendChild(newQuestion);

        setupComparisonTableQuestionEvents(newQuestion);
      }

      function setupComparisonTableQuestionEvents(questionElement) {
        questionElement
          .querySelector(".remove-question")
          .addEventListener("click", function () {
            questionElement.remove();
          });
      }

      // Dynamic assessment fields based on selected type
      document
        .getElementById("assessmentType")
        .addEventListener("change", function () {
          const type = this.value;
          const fieldsContainer = document.getElementById("assessmentFields");

          // Clear previous fields
          fieldsContainer.innerHTML = "";

          if (!type) return;

          // Based on the selected type, load appropriate fields
          switch (type) {
            case "multiple_choice":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Multiple Choice Questions</label>
              <div id="mcqContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" class="form-control question-input" placeholder="Question text">
                    </div>
                    <div class="mb-2">
                      <div class="input-group mb-2">
                        <div class="input-group-text">
                          <input class="form-check-input correct-answer" type="radio" name="correctAnswer1" value="A">
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option A">
                      </div>
                      <div class="input-group mb-2">
                        <div class="input-group-text">
                          <input class="form-check-input correct-answer" type="radio" name="correctAnswer1" value="B">
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option B">
                      </div>
                      <div class="input-group mb-2">
                        <div class="input-group-text">
                          <input class="form-check-input correct-answer" type="radio" name="correctAnswer1" value="C">
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option C">
                      </div>
                      <div class="input-group mb-2">
                        <div class="input-group-text">
                          <input class="form-check-input correct-answer" type="radio" name="correctAnswer1" value="D">
                        </div>
                        <input type="text" class="form-control option-input" placeholder="Option D">
                      </div>
                    </div>
                    <div class="d-flex justify-content-between">
                      <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                        <i class="fas fa-trash"></i> Remove
                      </button>
                      <button class="btn btn-sm btn-outline-success add-option" type="button">
                        <i class="fas fa-plus"></i> Add Option
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addMcq">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              // Setup events for the initial MCQ question
              const initialMcqQuestion = document.querySelector(
                "#mcqContainer .card"
              );
              if (initialMcqQuestion) {
                setupMcqQuestionEvents(initialMcqQuestion, 1);
              }

              document
                .getElementById("addMcq")
                .addEventListener("click", addMcqQuestion);
              break;

            case "true_false":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">True/False Questions</label>
              <div id="tfContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" class="form-control question-input" placeholder="Question text">
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="tfAnswer1" id="tfTrue1" value="true">
                      <label class="form-check-label" for="tfTrue1">True</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="tfAnswer1" id="tfFalse1" value="false">
                      <label class="form-check-label" for="tfFalse1">False</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger mt-2 remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addTf">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialTfQuestion =
                document.querySelector("#tfContainer .card");
              if (initialTfQuestion) {
                setupTfQuestionEvents(initialTfQuestion);
              }

              document
                .getElementById("addTf")
                .addEventListener("click", addTfQuestion);
              break;

            case "short_answer":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Short Answer Questions</label>
              <div id="saContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" class="form-control question-input" placeholder="Question text">
                    </div>
                    <div class="mb-3">
                      <input type="text" class="form-control answer-input" placeholder="Correct answer">
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addSa">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialSaQuestion =
                document.querySelector("#saContainer .card");
              if (initialSaQuestion) {
                setupSaQuestionEvents(initialSaQuestion);
              }

              document
                .getElementById("addSa")
                .addEventListener("click", addSaQuestion);
              break;

            case "essay":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Essay Questions</label>
              <div id="essayContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" class="form-control question-input" placeholder="Question prompt">
                    </div>
                    <div class="mb-3">
                      <textarea class="form-control" rows="3" placeholder="Sample answer (optional)"></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Grading Rubric</label>
                      <textarea class="form-control" rows="3" placeholder="Enter grading criteria"></textarea>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addEssay">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialEssayQuestion = document.querySelector(
                "#essayContainer .card"
              );
              if (initialEssayQuestion) {
                setupEssayQuestionEvents(initialEssayQuestion);
              }

              document
                .getElementById("addEssay")
                .addEventListener("click", addEssayQuestion);
              break;

            case "matching":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Matching Questions</label>
              <div id="matchingContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" class="form-control question-input" placeholder="Instructions (optional)">
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <label class="form-label">Items</label>
                        <div class="items-container">
                          <div class="input-group mb-2">
                            <input type="text" class="form-control item-input" placeholder="Item 1">
                            <button class="btn btn-outline-danger remove-item" type="button">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-item">
                          <i class="fas fa-plus"></i> Add Item
                        </button>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Matches</label>
                        <div class="matches-container">
                          <div class="input-group mb-2">
                            <input type="text" class="form-control match-input" placeholder="Match 1">
                            <button class="btn btn-outline-danger remove-match" type="button">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary add-match">
                          <i class="fas fa-plus"></i> Add Match
                        </button>
                      </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger mt-3 remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addMatching">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialMatchingQuestion = document.querySelector(
                "#matchingContainer .card"
              );
              if (initialMatchingQuestion) {
                setupMatchingQuestionEvents(initialMatchingQuestion);
              }

              document
                .getElementById("addMatching")
                .addEventListener("click", addMatchingQuestion);
              break;

            case "fill_blank":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Fill in the Blank Questions</label>
              <div id="fillBlankContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Question Text (use [blank] for blanks)</label>
                      <input type="text" class="form-control question-input" placeholder="E.g., The capital of France is [blank].">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Correct Answers (separate multiple answers with commas)</label>
                      <input type="text" class="form-control answer-input" placeholder="E.g., Paris, paris, PARIS">
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addFillBlank">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialFillBlankQuestion = document.querySelector(
                "#fillBlankContainer .card"
              );
              if (initialFillBlankQuestion) {
                setupFillBlankQuestionEvents(initialFillBlankQuestion);
              }

              document
                .getElementById("addFillBlank")
                .addEventListener("click", addFillBlankQuestion);
              break;

            case "4pics1word":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">4 Pics 1 Word Questions</label>
              <div id="picsContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Upload 4 Images</label>
                      <input type="file" class="form-control mb-2" accept="image/*" multiple>
                      <small class="text-muted">Please select exactly 4 images</small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Correct Answer</label>
                      <input type="text" class="form-control answer-input" placeholder="The word that connects all 4 images">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Hints (optional)</label>
                      <input type="text" class="form-control hint-input" placeholder="E.g., Starts with 'S', 5 letters">
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addPics">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialPicsQuestion = document.querySelector(
                "#picsContainer .card"
              );
              if (initialPicsQuestion) {
                setupPicsQuestionEvents(initialPicsQuestion);
              }

              document
                .getElementById("addPics")
                .addEventListener("click", addPicsQuestion);
              break;

            case "mind_mapping":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Mind Mapping Questions</label>
              <div id="mindMappingContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Central Topic</label>
                      <input type="text" class="form-control central-topic" placeholder="Enter the central topic">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Main Branches</label>
                      <div class="branches-container">
                        <div class="branch-group mb-3 border p-3 rounded">
                          <div class="input-group mb-2">
                            <input type="text" class="form-control branch-input" placeholder="Main branch 1">
                            <button class="btn btn-outline-danger remove-branch" type="button">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                          <div class="sub-branches-container ms-4">
                            <div class="input-group mb-2">
                              <input type="text" class="form-control sub-branch-input" placeholder="Sub-branch 1">
                              <button class="btn btn-outline-danger remove-sub-branch" type="button">
                                <i class="fas fa-times"></i>
                              </button>
                            </div>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-success add-sub-branch">
                            <i class="fas fa-plus"></i> Add Sub-branch
                          </button>
                        </div>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-primary add-branch">
                        <i class="fas fa-plus"></i> Add Main Branch
                      </button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addMindMapping">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialMindMappingQuestion = document.querySelector(
                "#mindMappingContainer .card"
              );
              if (initialMindMappingQuestion) {
                setupMindMappingQuestionEvents(initialMindMappingQuestion);
              }

              document
                .getElementById("addMindMapping")
                .addEventListener("click", addMindMappingQuestion);
              break;

            case "comparison_table":
              fieldsContainer.innerHTML = `
            <div class="mb-3">
              <label class="form-label">Comparison Table</label>
              <div id="comparisonTableContainer">
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Instructions</label>
                      <input type="text" class="form-control question-input" placeholder="Instructions (e.g., Fill in the comparison table)">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Table Headers (comma separated)</label>
                      <input type="text" class="form-control headers-input" placeholder="E.g., Feature,Animal,Plant">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Row Labels (comma separated)</label>
                      <input type="text" class="form-control rows-input" placeholder="E.g., Cell Structure,Reproduction,Energy Source">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Correct Answers (JSON format)</label>
                      <textarea class="form-control answers-input" rows="4" placeholder='[
        {
          "Feature": "Cell Structure",
          "Animal": "No cell wall",
          "Plant": "Has cell wall"
        },
        {
          "Feature": "Reproduction",
          "Animal": "Sexual",
          "Plant": "Asexual or sexual"
        }
      ]'></textarea>
                      <small class="form-text text-muted">
                        Provide correct answers in array of objects format. Each object should include values for all columns.
                      </small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-question" type="button">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="addComparisonTable">
                <i class="fas fa-plus"></i> Add Question
              </button>
            </div>
          `;

              const initialComparisonTableQuestion = document.querySelector(
                "#comparisonTableContainer .card"
              );
              if (initialComparisonTableQuestion) {
                setupComparisonTableQuestionEvents(
                  initialComparisonTableQuestion
                );
              }

              document
                .getElementById("addComparisonTable")
                .addEventListener("click", addComparisonTableQuestion);
              break;
          }
        });

      // Form submission handler
      document
        .getElementById("assessmentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(); // Use FormData instead of an object

          // Append basic fields
          formData.append(
            "title",
            document.getElementById("assessmentTitle").value
          );
          formData.append(
            "type",
            document.getElementById("assessmentType").value
          );
          formData.append(
            "total_points",
            document.getElementById("totalPoints").value
          );
          formData.append(
            "max_points",
            document.getElementById("maxPoints").value
          );
          formData.append(
            "time_limit",
            document.getElementById("timeLimit").value || ""
          );

          if (
            parseInt(document.getElementById("maxPoints").value) >
            parseInt(document.getElementById("totalPoints").value)
          ) {
            alert("Passing points is greater than total points.");
            return;
          }

          formData.append(
            "instructions",
            CKEDITOR.instances["editor"].getData()
          );

          formData.append(
            "status",
            e.submitter.id === "saveAssessmentDraft" ? "draft" : "published"
          );

          // Append questions
          const questions = gatherQuestionsData();

          // In the form submission handler, replace the question handling with:
          questions.forEach((question, qIndex) => {
            // Handle special cases with files
            if (
              document.getElementById("assessmentType").value === "4pics1word"
            ) {
              formData.append(
                `questions[${qIndex}][correctAnswer]`,
                question.correctAnswer
              );
              formData.append(
                `questions[${qIndex}][hint]`,
                question.hint || ""
              );
              question.images.forEach((file) => {
                formData.append(`questions[${qIndex}][images][]`, file);
              });
            } else {
              // Generic handling for other question types
              Object.entries(question).forEach(([key, value]) => {
                if (Array.isArray(value)) {
                  // Handle arrays (options, items, matches, etc.)
                  value.forEach((item, i) => {
                    if (typeof item === "object") {
                      // Handle nested objects (e.g. options with value/text)
                      Object.entries(item).forEach(([subKey, subValue]) => {
                        formData.append(
                          `questions[${qIndex}][${key}][${i}][${subKey}]`,
                          subValue
                        );
                      });
                    } else {
                      formData.append(`questions[${qIndex}][${key}][]`, item);
                    }
                  });
                } else if (typeof value === "object" && value !== null) {
                  // Handle objects (e.g. mind mapping branches)
                  Object.entries(value).forEach(([subKey, subValue]) => {
                    formData.append(
                      `questions[${qIndex}][${key}][${subKey}]`,
                      subValue
                    );
                  });
                } else {
                  // Handle primitive values
                  formData.append(`questions[${qIndex}][${key}]`, value);
                }
              });
            }
          });

          // Save assessment data (in a real app, this would be an API call)
          // console.log("Assessment data to be saved:", assessmentData);

          try {
            const response = await fetch(
              `https://mahusci.rubenianinternational.com/public/api/lessons/assessments`,
              {
                method: "POST",
                headers: {
                  Accept: "application/json",
                  // "Content-type": "application/json",
                  Authorization: "Bearer " + sessionStorage.getItem("token"),
                },
                body: formData,
              }
            );

            const data = await response.json();
            if (response.ok) {
              // window.location.href = `/teacher/assessments/${data.assessment.id}`;
            } else {
              throw new Error(data.message || "Failed to create assessment");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error creating assessment: " + error.message);
          }

          document.getElementById("assessmentForm").reset();

          // Redirect to lesson view or assessments list
          alert("Assessment created successfully!");
          //   window.location.href = `/teacher/lessons.html`;
        });

      // Function to gather all questions data based on type
      function gatherQuestionsData() {
        const type = document.getElementById("assessmentType").value;
        const questions = [];

        switch (type) {
          case "multiple_choice":
            document
              .querySelectorAll("#mcqContainer .card")
              .forEach((card, index) => {
                const question = {
                  text: card.querySelector(".question-input").value,
                  options: [],
                  correctAnswer: null,
                };

                card
                  .querySelectorAll(".input-group")
                  .forEach((optionGroup, i) => {
                    const optionQuestionText =
                      card.querySelector(".question-input").value;
                    const optionValue = String.fromCharCode(65 + i);
                    const optionText =
                      optionGroup.querySelector(".option-input").value;
                    const isCorrect =
                      optionGroup.querySelector(".correct-answer").checked;

                    question.options.push({
                      value: optionValue,
                      text: optionText,
                    });

                    if (isCorrect) {
                      question.correctAnswer = optionValue;
                    }
                  });

                questions.push(question);
              });
            break;

          case "true_false":
            document
              .querySelectorAll("#tfContainer .card")
              .forEach((card, index) => {
                const question = {
                  text: card.querySelector(".question-input").value,
                  correctAnswer: card.querySelector(
                    "input[name='tfAnswer" + (index + 1) + "']:checked"
                  )?.value,
                };
                questions.push(question);
              });
            break;

          case "short_answer":
            document.querySelectorAll("#saContainer .card").forEach((card) => {
              const question = {
                text: card.querySelector(".question-input").value,
                correctAnswer: card.querySelector(".answer-input").value,
              };
              questions.push(question);
            });
            break;

          case "essay":
            document
              .querySelectorAll("#essayContainer .card")
              .forEach((card) => {
                const question = {
                  text: card.querySelector(".question-input").value,
                  sampleAnswer: card.querySelector("textarea").value,
                  rubric: card.querySelectorAll("textarea")[1].value,
                };
                questions.push(question);
              });
            break;

          case "matching":
            document
              .querySelectorAll("#matchingContainer .card")
              .forEach((card) => {
                const items = Array.from(
                  card.querySelectorAll(".item-input")
                ).map((input) => input.value);
                const matches = Array.from(
                  card.querySelectorAll(".match-input")
                ).map((input) => input.value);

                const question = {
                  listOfCorrectAanswers:
                    card.querySelector(".question-input").value,
                  items: items,
                  matches: matches,
                  // Note: In a real app, you might want to store correct pairings
                };
                questions.push(question);
              });
            break;

          case "fill_blank":
            document
              .querySelectorAll("#fillBlankContainer .card")
              .forEach((card) => {
                const question = {
                  text: card.querySelector(".question-input").value,
                  correctAnswers: card
                    .querySelector(".answer-input")
                    .value.split(",")
                    .map((s) => s.trim()),
                };
                questions.push(question);
              });
            break;

          case "4pics1word":
            document
              .querySelectorAll("#picsContainer .card")
              .forEach((card) => {
                const question = {
                  // Note: File handling would need additional processing
                  images: Array.from(
                    card.querySelector("input[type='file']").files
                  ),
                  correctAnswer: card.querySelector(".answer-input").value,
                  hint: card.querySelector(".hint-input").value || null,
                };
                questions.push(question);
              });
            break;

          case "mind_mapping":
            document
              .querySelectorAll("#mindMappingContainer .card")
              .forEach((card) => {
                const centralTopic = card.querySelector(".central-topic").value;
                const branches = [];

                card
                  .querySelectorAll(".branch-group")
                  .forEach((branchGroup) => {
                    const branch = {
                      name: branchGroup.querySelector(".branch-input").value,
                      subBranches: Array.from(
                        branchGroup.querySelectorAll(".sub-branch-input")
                      ).map((input) => input.value),
                    };
                    branches.push(branch);
                  });

                const question = {
                  centralTopic: centralTopic,
                  branches: branches,
                };
                questions.push(question);
              });
            break;

          case "comparison_table":
            document
              .querySelectorAll("#comparisonTableContainer .card")
              .forEach((card) => {
                const question = {
                  instructions: card.querySelector(".question-input").value,
                  headers: card
                    .querySelector(".headers-input")
                    .value.split(",")
                    .map((s) => s.trim()),
                  rowLabels: card
                    .querySelector(".rows-input")
                    .value.split(",")
                    .map((s) => s.trim()),
                  correctAnswers: JSON.parse(
                    card.querySelector(".answers-input").value || "[]"
                  ),
                };
                questions.push(question);
              });
            break;

          default:
            console.warn(
              "Question data gathering not implemented for type:",
              type
            );
        }

        return questions;
      }
      // Save draft handler
      // document
      //   .getElementById("saveAssessmentDraft")
      //   .addEventListener("click", async function () {
      //     const assessmentData = {
      //       title: document.getElementById("assessmentTitle").value,
      //       type: document.getElementById("assessmentType").value,
      //       total_points: document.getElementById("totalPoints").value,
      //       time_limit: document.getElementById("timeLimit").value || null,
      //       instructions: document.getElementById("assessmentInstructions")
      //         .value,
      //       questions: gatherQuestionsData(),
      //       status: "draft",
      //     };

      //     console.log("Saving as draft:", assessmentData);

      //     try {
      //       const response = await fetch(
      //         `https://mahusci.rubenianinternational.com/public/api/lessons/assessments`,
      //         {
      //           method: "POST",
      //           headers: {
      //             Accept: "application/json",
      //           },
      //           body: assessmentData,
      //         }
      //       );

      //       const data = await response.json();
      //       if (response.ok) {
      //         // window.location.href = `/teacher/assessments/${data.assessment.id}`;
      //       } else {
      //         throw new Error(data.message || "Failed to create assessment");
      //       }
      //     } catch (error) {
      //       console.error("Error:", error);
      //       alert("Error creating assessment: " + error.message);
      //     }

      //     alert("Assessment saved as draft successfully!");
      //   });

      // Initialize with the first assessment type if needed
      document
        .getElementById("assessmentType")
        .dispatchEvent(new Event("change"));
    </script>
  </body>
</html>
